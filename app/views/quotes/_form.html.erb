<% cancel_path = @quote.persisted? ? quote_path(@quote) : quotes_path %>

<%= form_with model: @quote, local: true, html: { class: "form-card" } do |form| %>
  <% if @quote.errors.any? %>
    <div class="form-card__errors" role="alert">
      <h2 class="form-card__errors-title"><%= pluralize(@quote.errors.count, "error") %> prevented saving this quote</h2>
      <ul class="form-card__error-list">
        <% @quote.errors.full_messages.each do |message| %>
          <li><%= message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <div class="form-field">
    <%= form.label :text, "Quote", class: "form-field__label" %>
    <%= form.text_area :text, required: true, rows: 4, class: "form-field__control" %>
    <p class="form-field__hint">Share the quote exactly as it was written. Weâ€™ll add the smart quotes for you.</p>
  </div>

  <div class="form-field">
    <%= form.label :philosopher_first_name, "Philosopher", class: "form-field__label" %>
    <div class="form-field__stack">
      <div class="form-field__stack-item">
        <%= label_tag "quote_philosopher_first_name", "Philosopher first name", class: "sr-only" %>
        <%= text_field_tag "quote[philosopher_first_name]", params.dig(:quote, :philosopher_first_name) || @quote.philosopher&.first_name, required: true, class: "form-field__control", placeholder: "First name" %>
      </div>
      <div class="form-field__stack-item">
        <%= label_tag "quote_philosopher_last_name", "Philosopher last name", class: "sr-only" %>
        <%= text_field_tag "quote[philosopher_last_name]", params.dig(:quote, :philosopher_last_name) || @quote.philosopher&.last_name, class: "form-field__control", placeholder: "Last name (optional)" %>
      </div>
    </div>
    <p class="form-field__hint">Type the philosopher's name exactly as you want it to appear.</p>
  </div>

  <div class="form-field">
    <%= form.label :philosopher_biography, "Short biography", class: "form-field__label" %>
    <%= text_area_tag "quote[philosopher_biography]", params.dig(:quote, :philosopher_biography) || @quote.philosopher&.biography, rows: 3, class: "form-field__control", placeholder: "Optional context about the philosopher" %>
    <p class="form-field__hint">Share a quick note or background to help others learn more. This field is optional.</p>
  </div>

  <div class="form-field" data-category-selector>
    <%= form.label :category_ids, "Categories", class: "form-field__label" %>
    <div class="category-selector__control">
      <%= select_tag :category_picker, options_from_collection_for_select(@categories, :id, :name), prompt: "Select a category", class: "form-field__control category-selector__select", data: { category_selector_target: "select" } %>
      <button type="button" class="button button--subtle button--sm category-selector__add" data-category-selector-add>Add</button>
    </div>
    <div class="category-selector__list" data-category-selector-list>
      <% @quote.categories.each do |category| %>
        <div class="category-chip" data-category-chip data-category-id="<%= category.id %>">
          <span class="category-chip__label" data-category-name><%= category.name %></span>
          <button type="button" class="category-chip__remove" data-category-remove aria-label="Remove <%= category.name %>">&times;</button>
          <input type="hidden" name="quote[category_ids][]" value="<%= category.id %>" data-category-value>
        </div>
      <% end %>
      <p class="category-selector__empty" data-category-selector-empty <%= @quote.categories.any? ? 'hidden' : '' %>>No categories selected yet.</p>
    </div>
    <p class="form-field__hint">Add each category individually. Selected categories stack as cards below.</p>

    <template data-category-selector-template>
      <div class="category-chip" data-category-chip>
        <span class="category-chip__label" data-category-name></span>
        <button type="button" class="category-chip__remove" data-category-remove aria-label="Remove category">&times;</button>
        <input type="hidden" name="quote[category_ids][]" value="" data-category-value>
      </div>
    </template>
  </div>

  <div class="form-field">
    <%= form.label :publication_year, "Publication year", class: "form-field__label" %>
    <%= form.number_field :publication_year, placeholder: "e.g. 1879", class: "form-field__control" %>
    <p class="form-field__hint">Optional. Add the year the quote first appeared.</p>
  </div>

  <div class="form-field">
    <%= form.label :user_comment, "Your reflection", class: "form-field__label" %>
    <%= form.text_area :user_comment, rows: 3, placeholder: "What does this quote mean to you?", class: "form-field__control" %>
    <p class="form-field__hint">Optional. Share context or personal insight for other readers.</p>
  </div>

  <div class="form-field form-field--checkbox">
    <div class="form-field__option">
      <%= form.check_box :is_public %>
    </div>
    <div>
      <%= form.label :is_public, "Make this quote public", class: "form-field__label" %>
      <p class="form-field__hint">Public quotes appear on the Discover page for everyone to enjoy.</p>
    </div>
  </div>

  <div class="form-card__actions">
    <%= link_to "Cancel", cancel_path, class: "button button--subtle" %>
    <%= form.submit(@quote.persisted? ? "Save changes" : "Create quote", class: "button") %>
  </div>
<% end %>
